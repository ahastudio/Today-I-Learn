# 12장 - 실전 프로그램 개발 - 콘텐츠 편집 기능(Bookmark, Blog 앱)
- 콘텐츠의 생성 및 변경 기능을 작성한다.
- 다음과 같은 권한 부여 요구 사항을 적용한다.
    - 콘텐츠 Read: 모든 사용자
    - 콘텐츠 Create: 로그인한 사용자만
    - 콘텐츠 Update, Delete: 그 콘텐츠를 생성한 사용자만

# 12.1 애플리케이션 설계하기
- 콘텐츠 편집 기능을 개발
- CRUD 기능은 테이블 단위로 처리되므로, 테이블에 대한 CRUD 기능을 구현하는 것이 핵심

# 12.1.1 화면 UI 설계
- 콘텐츠 편집은 페이지 상단의 [ADD]와 [Change]메뉴에 구현한다.
- CreateView 및 UpdateView에서 자동으로 만들어준 폼을 사용한다.

# 12.1.2 테이블 설계
- 콘텐츠의 소유자를 고려해야한다.
- 각 콘텐츠 테이블별로 소유자 필드가 필요하다.
- 표 12-1 테이블 설계 - 기존 테이블 변경(Bookmark 모델 클래스)

| 필드명 | 타입             | 제약 조건          | 설명          |
|--------|------------------|--------------------|---------------|
| Id     | Integer          | PK, Auto Increment | 기본 키       |
| Title  | CharField(100)   | Blank, Null        | 북마크 제목   |
| url    | URLField         | Unique             | 북마크 URL    |
| owner  | ForeignKey(User) | Null               | 북마크 소유자 | 

- 표 12-2 테이블 설계 - 기존 테이블 변경(Post 모델 클래스)

| 필드명      | 타입             | 제약 조건          | 설명                   |
|-------------|------------------|--------------------|------------------------|
| Id          | Integer          | PK, Auto Increment | 기본 키                |
| title       | CharField(50)    |                    | 포스트 제목            |
| slug        | SlugField(50)    | Unique             | 포스트 제목 별칭       |
| description | CharField(100)   | Blank              | 포스트 내용 한 줄 설명 |
| content     | TextField        |                    | 포스트 내용 기록       |
| create_date | DateTimeField    | auto_now_add       | 포스트를 생성한 날짜   |
| modify_date | DateTimeField    | auto_now           | 포스트를 수정한 날짜   |
| owner       | ForeignKey(User) | Null               | 포스트 소유자          |

# 12.1.3 URL 설계
- 콘텐츠별로 생성, 수정, 삭제 작업을 요청할 수 있는 URl이 필요하다.
- 기존 앱에서 정의한 URLconf에 다음 URl을 추가해 설계한다.
    - Create(생성)
    - Update(수정)
    - Delete(삭제)
    - Change(변경 대상 리스트)
- 표 12-3 URL 설계 - 기존 URL 변경(북마크 앱)

| URL 패턴              | 뷰 이름                        | 템플릿 파일명                |
|-----------------------|--------------------------------|------------------------------|
| /bookmark/            | BookmarkLV(ListView)           | bookmark_list.html           |
| /bookmark/99/         | BookmarkDV(DetailView)         | bookmark_detail.html         |
| /bookmark/add/*       | BookmarkCreateView(CreateView) | bookmark_form.html           |
| /bookmark/change/     | BookmarkChangeLV(ListView)     | bookmark_change_list.html    |
| /bookmark/99/update/* | BookmarkUpdateView(UpdateView) | bookmark_form.html           |
| /bookmark/99/delete   | BookmarkDeleteView(DeleteView) | bookmark_confirm_delete.html |
- \* /add/와 /update/에 대한 템플릿 파일은 동일함

- 표 12-4 URL 설계 - 기존 URL 변경(블로그 앱)

| URL 패턴                   | 뷰 이름                    | 템플릿 파일명            |
|----------------------------|----------------------------|--------------------------|
| /blog/                     | PostLV(ListView)           | post_all.html            |
| /blog/post/                | PostLV(ListView)           | post_all.html            |
| /blog/post/django-example/ | PostDV(DetailView)         | post_detail.html         |
| /blog/archive/             | PostAV(ArchiveIndexView)   | post_archive.html        |
| /blog/2012/                | PostYAV(YearArchiveView)   | post_archive_year.html   |
| /blog/2012/nov             | PostMAV(MonthArchiveView)  | post_archive_month.html  |
| /blog/2012/nov/10/         | PostDAV(DayArchiveView)    | post_archive_day.html    |
| /blog/today/               | PostTAV(TodayArchiveView)  | post_archive_day.html    |
| /blog/add/*                | PostCreateView(CreateView) | post_form.html           |
| /blog/change/              | PostChangeLV(ListView)     | post_change_list.html    |
| /blog/99/update/*          | PostUpdateView(UpdateView) | post_form.html           |
| /blog/99/delete/           | PostDeleteView(DeleteView) | post_confirm_delete.html |
- \* /add/와 /update/에 대한 템플릿 파일은 동일함

# 12.1.4 작업/코딩 순서
- 작업 순서는 다음과 같다.
- 표 12-5 작업/코딩 순서 - 북마크/블로그 앱 편집

| 작업 순서        | 관련 명령/파일     | 필요한 작업 내용                   |
|------------------|--------------------|------------------------------------|
| 뼈대 만들기      | startproject       | (2장에서 완료함)                   |
|                  | settings.py        |                                    |
|                  | migrate            |                                    |
|                  | createsuperuser    |                                    |
|                  | startapp           | (변경 사항 없음)                   |
|                  | settings.py        |                                    |
| 모델 코딩하기    | models.py          | owner 필드 추가                    |
|                  | admin.py           | (변경 사항 없음)                   |
|                  | makemigrations     | 변경 사항을 데이터베이스에 반영    |
|                  | migrate            |                                    |
| URLconf 코딩하기 | urls.py            | URL 정의                           |
| 뷰 코딩하기      | views.py           | 뷰 로직 작성                       |
| 템플릿 코딩하기  | templates 디렉터리 | 템플릿 파일 작성                   |
| 그 외 코딩하기   | static 디렉터리    | 테이블 모양 정의를 base.css에 추가 |

# 12.2 개발 코딩하기
- 콘텐츠별로 소유자 속성이 필요하고 편집 권한에 대한 확인 기능도 필요하다.
- 장고에서 제공해주는 제네릭 뷰를 사용해서 이런 편집 기능을 구현한다.

# 12.2.1 뼈대 만들기
- 신규로 추가할 앱이 없어서, 뼈대 작업은 불필요함

# 12.2.2 모델 코딩하기
- 북마크, 블로그 앱의 각 테이블별로 owner 필드를 추가한다.

- bookmark/models.py
```python
from django.db import models
from django.contrib.auth.models import User


# Create your models here.
class Bookmark(models.Model):
    title = models.CharField(max_length=100, blank=True, null=True)
    url = models.URLField('url', unique=True)
    owner = models.ForeignKey(User, null=True)
    # Bookmark : User = N : 1 이므로 User를 외래키로 사용함
    # 이미 Bookmark 테이블의 레코드가 존재하므로 owner 필드에 null=True를 지정함

    def __str__(self):
        return self.title
```


- blog/models.py
```python
from django.contrib.auth.models import User
from django.utils.text import slugify   # slug 필드를 자동으로 채우기 위해 slugify를 import 함


# Create your models here.
class Post(models.Model):
        ...
    owner = models.ForeignKey(User, null=True)
        ...
    
    
        ...
    def get_next_post(self):
        return self.get_next_by_modify_date()

    # save() 메소드를 재정의한다. 모델 객체의 내용을 데이터베이스에 저장하는 메소드이다.
    def save(self, *args, **kwargs):
        # 테이블에 저장 시 self.id를 확인해 False인 경우, 즉 처음으로 저장하는 경우에만 slug 필드를 title 필드의 단어로 변환해 자동으로 채워준다.
        if not self.id:
            # slugify() 함수는 원래 단어를 알파벳 소문자, 숫자, 밑줄, 하이픈으로만 구성된 단어로 만들어주는 함수임
            self.slug = slugify(self.title, allow_unicode=True)
        # 부모 클래스의 save() 메소드를 호출해 객체의 내용을 테이블에 반영하는 save() 메소드의 원래 기능을 수행한다.
        super(Post, self).save(*args, **kwargs)
```
- models.ForeignKey를 사용할 경우 필수로 설정해야하는 값이 있다.
- ForeignKeyField가 바라볼 모델과 on_delete 옵션이다.
- 콘텐츠의 owner가 삭제되어도 콘텐츠는 유지해야하므로 models.SET_NULL 옵션을 설정했다.
- null=True일 때만 가능하다. (이미 만들어진 콘텐츠가 있어서 null=True로 설정했었음)
- 참고 링크:
    - [블로그](https://lee-seul.github.io/django/backend/2018/01/28/django-model-on-delete.html)
    - [공식문서 - ForeignKey](https://docs.djangoproject.com/en/2.2/ref/models/fields/)
    - [공식문서 - on_delete 옵션](https://docs.djangoproject.com/en/2.2/ref/models/fields/#django.db.models.ForeignKey.on_delete)

- 데이터베이스에 반영하기
>> python manage.py makemigrations <br>
>> python manage.py migrate

# 12.2.3 URLconf 코딩하기
- 북마크, 블로그 앱의 각 URLconf에 콘텐츠 편집 기능에 관련된 URL을 추가한다.

- bookmark/urls.py
```python

```
- Bookmark 테이블에 대한 생성, 변경 대상 리스트, 수정, 삭제 기능을 위한 URL을 추가한다.